name: HyperCPU CI/CD Pipeline (version incrementing)

on:
  push:
    branches:
      - master

jobs:
  versioning-patch-increment:
    runs-on: ubuntu-latest
    container: hyperwin/hcpu-ci:debian-unstable
    if: contains(github.event.head_commit.message, '[ci patch inc]')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git user
        uses: fregante/setup-git-user@v1

      - name: Increment version (patch)
        run: tools/increment_version.py --increment patch

      - name: Auto-commit version bump
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "[auto]: Increment patch version"
          branch: master

  versioning-minor-increment:
    runs-on: ubuntu-latest
    container: hyperwin/hcpu-ci:debian-unstable
    if: contains(github.event.head_commit.message, '[ci minor inc]')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git user
        uses: fregante/setup-git-user@v1

      - name: Increment version (minor)
        run: tools/increment_version.py --increment minor

      - name: Auto-commit version bump
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "[auto]: Increment minor version"
          branch: master
